name: CI

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'
      - 'tests/**'
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      tests: ${{ steps.filter.outputs.tests }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            code:
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            tests:
              - 'tests/**'

  commitlint:
    name: Lint Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
      - name: Validate commit messages
        uses: wagoid/commitlint-github-action@b948419dd99f3fd78a6548d48f94e3df7f6bf3ed # v6

  check-base:
    name: Check Branch Base
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 0
      - name: Verify branch is rebased on main
        run: |
          git fetch origin main
          base_commit=$(git merge-base origin/main HEAD)
          main_head=$(git rev-parse origin/main)
          if [ "$base_commit" != "$main_head" ]; then
            behind=$(git rev-list --count $base_commit..$main_head)
            echo "::error::Branch is $behind commit(s) behind main. Rebase required."
            echo "Run: git fetch origin && git rebase origin/main"
            exit 1
          fi
          echo "Branch is up to date with main."

  deny:
    name: Audit Dependencies
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install cargo-deny
        uses: taiki-e/install-action@288875dd3d64326724fa6d9593062d9f8ba0b131 # v2
        with:
          tool: cargo-deny
      - name: Run cargo-deny
        run: cargo deny check

  format:
    name: Check Format
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
        with:
          toolchain: stable
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
        with:
          toolchain: stable
          components: clippy
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run Clippy lints
        run: cargo clippy -- -D warnings
      - name: Build examples
        run: cargo build --examples -p aptu-core

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
        with:
          toolchain: stable
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run tests
        run: cargo test

  build-release:
    name: Build Release Binary
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@efa25f7f19611383d5b0ccf2d1c8914531636bf9 # stable
        with:
          toolchain: stable
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Build release binary
        run: cargo build --profile ci
      - name: Upload release binary
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: aptu-binary
          path: target/ci/aptu
          retention-days: 1

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [changes, test, build-release]
    timeout-minutes: 15
    if: |
      (needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true') &&
      !contains(github.event.pull_request.labels.*.name, 'skip-integration') &&
      (needs.test.result == 'success' || github.event_name != 'pull_request') &&
      (needs.build-release.result == 'success' || github.event_name != 'pull_request')
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      - name: Download release binary
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: aptu-binary
          path: target/ci
      - name: Make binary executable
        run: chmod +x target/ci/aptu
      - name: Setup Bats testing framework
        uses: bats-core/bats-action@e412797c46257a2dbf3775f6f6010b33ee6cb99f # v3
        with:
          support-path: ${{ github.workspace }}/.bats-libs/bats-support
          assert-path: ${{ github.workspace }}/.bats-libs/bats-assert
          file-path: ${{ github.workspace }}/.bats-libs/bats-file
          detik-install: false
      - name: Run integration tests
        env:
          APTU_BIN: ${{ github.workspace }}/target/ci/aptu
          BATS_LIB_PATH: ${{ github.workspace }}/.bats-libs
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: bats tests/integration.bats

  ci-result:
    name: CI Result
    runs-on: ubuntu-latest
    if: always()
    needs: [commitlint, check-base, deny, format, lint, test, build-release, integration]
    steps:
      - name: Verify all jobs passed or were skipped
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "::error::One or more CI jobs failed or were cancelled."
            exit 1
          fi
          echo "All CI jobs passed or were skipped."

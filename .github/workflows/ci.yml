name: CI

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'
      - 'tests/**'
  pull_request:
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'
      - 'tests/**'
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      tests: ${{ steps.filter.outputs.tests }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            code:
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/**'
            tests:
              - 'tests/**'
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'

  format:
    name: Check Format
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - run: cargo clippy -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true' || github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - run: cargo test

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15
    if: |
      !contains(github.event.pull_request.labels.*.name, 'skip-integration') &&
      (needs.test.result == 'success' || github.event_name != 'pull_request')
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@ad397744b0d591a723ab90405b7247fac0e6b8db # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Build release binary
        run: cargo build --release
      - uses: bats-core/bats-action@e412797c46257a2dbf3775f6f6010b33ee6cb99f # v3.0.1
        with:
          support-path: ${{ github.workspace }}/.bats-libs/bats-support
          assert-path: ${{ github.workspace }}/.bats-libs/bats-assert
          file-path: ${{ github.workspace }}/.bats-libs/bats-file
          detik-install: false
      - name: Run integration tests
        env:
          APTU_BIN: ${{ github.workspace }}/target/release/aptu
          BATS_LIB_PATH: ${{ github.workspace }}/.bats-libs
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: bats tests/integration.bats

name: CI

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/**'
      - 'tests/**'
  pull_request:
  merge_group:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      tests: ${{ steps.filter.outputs.tests }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            code:
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
              - '.github/workflows/**'
            tests:
              - 'tests/**'
              - 'crates/**'
              - 'Cargo.toml'
              - 'Cargo.lock'

  commitlint:
    name: Lint Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0
      - name: Validate commit messages
        uses: wagoid/commitlint-github-action@f133a0d95090ef2609192b4a21f54e20af819ea9 # v6

  format:
    name: Check Format
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --check

  spdx:
    name: Check SPDX Headers
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 5
    continue-on-error: true
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Check SPDX headers on Rust files
        run: |
          missing=$(find crates -name "*.rs" -type f -exec grep -L "SPDX-License-Identifier" {} \;)
          if [ -n "$missing" ]; then
            echo "Files missing SPDX headers:"
            echo "$missing"
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
          components: clippy
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run Clippy lints
        run: cargo clippy -- -D warnings

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: changes
    timeout-minutes: 10
    if: needs.changes.outputs.code == 'true' || needs.changes.outputs.tests == 'true' || github.event_name != 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Run tests
        run: cargo test

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 15
    if: |
      !contains(github.event.pull_request.labels.*.name, 'skip-integration') &&
      (needs.test.result == 'success' || github.event_name != 'pull_request')
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@401aff9a7a08acb9d27b64936a90db81024cff97 # v2
        with:
          shared-key: "aptu"
          save-if: ${{ github.ref == 'refs/heads/main' }}
      - name: Build release binary
        run: cargo build --release
      - name: Setup Bats testing framework
        uses: bats-core/bats-action@e412797c46257a2dbf3775f6f6010b33ee6cb99f # v3
        with:
          support-path: ${{ github.workspace }}/.bats-libs/bats-support
          assert-path: ${{ github.workspace }}/.bats-libs/bats-assert
          file-path: ${{ github.workspace }}/.bats-libs/bats-file
          detik-install: false
      - name: Run integration tests
        env:
          APTU_BIN: ${{ github.workspace }}/target/release/aptu
          BATS_LIB_PATH: ${{ github.workspace }}/.bats-libs
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: bats tests/integration.bats

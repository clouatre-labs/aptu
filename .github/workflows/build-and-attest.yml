name: Build and Attest

on:
  workflow_call:
    inputs:
      target:
        required: true
        type: string
        description: Rust target triple (e.g., x86_64-unknown-linux-musl)
      os:
        required: true
        type: string
        description: Runner OS (e.g., ubuntu-latest, macos-latest, windows-latest)
      cross:
        required: true
        type: boolean
        description: Whether to use cross-compilation tools
      version:
        required: true
        type: string
        description: Release version for archive naming (e.g., 0.1.3)
      dry_run:
        required: false
        type: boolean
        default: false
        description: Dry run mode (skip upload and attestation)

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-attest:
    name: Build ${{ inputs.target }}
    runs-on: ${{ inputs.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      - name: Install cosign
        uses: sigstore/cosign-installer@398d4b0eeef1380460a10c8013a76f728fb906ac # v3
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # stable
        with:
          toolchain: stable
          targets: ${{ inputs.target }}
      - name: Install cross-compilation tools
        if: ${{ inputs.cross }}
        uses: taiki-e/setup-cross-toolchain-action@15a579e0045e5e4f668b73a441b9609884abffc9 # v1
        with:
          target: ${{ inputs.target }}
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          shared-key: aptu
          key: ${{ inputs.target }}
      - name: Install cargo-deb
        if: ${{ startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux') }}
        uses: taiki-e/install-action@a983ca795126a4be4e8a44879ac5c4c3ef66cae1 # v2
        with:
          tool: cargo-deb
      - name: Build and upload binary
        if: ${{ !inputs.dry_run }}
        id: upload
        uses: taiki-e/upload-rust-binary-action@3962470d6e7f1993108411bc3f75a135ec67fc8c # v1
        with:
          bin: aptu
          target: ${{ inputs.target }}
          token: ${{ secrets.GITHUB_TOKEN }}
          checksum: sha256
          archive: aptu-${{ inputs.version }}-$target
      - name: Build binary (dry-run)
        if: ${{ inputs.dry_run }}
        run: cargo build --release --target ${{ inputs.target }} -p aptu-cli
      - name: Generate .deb package
        if: ${{ !inputs.dry_run && (startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux')) }}
        run: cargo deb --target ${{ inputs.target }} --no-build
      - name: Upload .deb to release
        if: ${{ !inputs.dry_run && (startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux')) }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEB_FILE=$(find target/${{ inputs.target }}/debian -name "*.deb" -type f)
          if [ -n "$DEB_FILE" ]; then
            gh release upload ${{ github.ref_name }} "$DEB_FILE" --clobber
          fi
      - name: Sign tarball with cosign
        if: ${{ !inputs.dry_run }}
        run: |
          cosign sign-blob --yes --bundle "${{ steps.upload.outputs.tar }}.bundle" "${{ steps.upload.outputs.tar }}"
      - name: Upload tarball .bundle to release
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} "${{ steps.upload.outputs.tar }}.bundle" --clobber
      - name: Attest build provenance (tarball)
        if: ${{ !inputs.dry_run }}
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: ${{ steps.upload.outputs.tar }}
      - name: Sign .deb with cosign
        if: ${{ !inputs.dry_run && (startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux')) }}
        run: |
          DEB_FILE=$(find target/${{ inputs.target }}/debian -name "*.deb" -type f)
          if [ -n "$DEB_FILE" ]; then
            cosign sign-blob --yes --bundle "$DEB_FILE.bundle" "$DEB_FILE"
          fi
      - name: Upload .deb .bundle to release
        if: ${{ !inputs.dry_run && (startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux')) }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEB_FILE=$(find target/${{ inputs.target }}/debian -name "*.deb" -type f)
          if [ -n "$DEB_FILE" ]; then
            gh release upload ${{ github.ref_name }} "$DEB_FILE.bundle" --clobber
          fi
      - name: Attest build provenance (.deb)
        if: ${{ !inputs.dry_run && (startsWith(inputs.target, 'x86_64-unknown-linux') || startsWith(inputs.target, 'aarch64-unknown-linux')) }}
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-path: target/${{ inputs.target }}/debian/*.deb
